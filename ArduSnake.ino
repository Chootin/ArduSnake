#include <Arduboy2.h>

#define BLOCK_WIDTH 4
#define MAX_X (WIDTH / BLOCK_WIDTH)
#define MAX_Y (HEIGHT / BLOCK_WIDTH)
#define MAX_SNAKE (MAX_X * MAX_Y)
#define INITIAL_LENGTH 3
#define RIGHT 0
#define DOWN 1
#define LEFT 2
#define UP 3

struct block {
  int x;
  int y;
};

struct snake {
  struct block *chunks;
  unsigned int length;
};

const unsigned char TITLE_SCREEN_LEFT[] PROGMEM = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xe0, 0xe0, 0xf0, 0xf0, 0x70, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0x60, 0x60, 0x60, 0xe0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xf0, 0xf8, 0xfc, 0x7c, 0x3e, 0x3e, 0x1e, 0x1f, 0xf, 0xf, 0xf, 0xf, 0xf, 0x8f, 0x87, 0xe7, 0xff, 0xff, 0xff, 0x1f, 0x3, 0x3, 0x1, 0x7d, 0xfe, 0xff, 0xff, 0xbb, 0xd9, 0xd9, 0x99, 0xf9, 0xf9, 0xfb, 0xfb, 0xff, 0x7f, 0x7f, 0x3f, 0x00, 0x00, 0x00, 0x80, 0xe0, 0xff, 0xff, 0x7f, 0x7f, 0x63, 0x63, 0x63, 0x43, 0x43, 0x83, 0x83, 0x7, 0x7, 0x7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xf0, 0x40, 0x00, 0x00, 0x00, 0x6, 0x2, 0x1, 0x81, 0x40, 0x00, 0x00, 0x18, 0xc, 0xc, 0xf, 0x3c, 0x38, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xec, 0xe7, 0xed, 0xe0, 0xe0, 0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf8, 0xf8, 0xfc, 0xfe, 0xff, 0xff, 0x3f, 0xf, 0xf, 0x1e, 0x18, 0x38, 0x38, 0x30, 0x00, 0x00, 0x00, 0x81, 0xe3, 0xfe, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1, 0x3, 0x7, 0x7, 0xf, 0x3c, 0x78, 0xf8, 0xf8, 0xf8, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xf0, 0x18, 0x00, 0x3, 0x3, 0x7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0x1f, 0x7, 0x7, 0x7, 0x7, 0xf, 0x1f, 0x1f, 0x1c, 0x00, 0x00, 0x80, 0xc0, 0xe0, 0xe0, 0xf1, 0xf0, 0x78, 0x3e, 0x3f, 0x1f, 0xf, 0x3, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1, 0x3, 0x3, 0x7, 0xf, 0xf, 0x1e, 0x1e, 0x3e, 0x3f, 0x7c, 0x7c, 0xf8, 0xf0, 0xf8, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x80, 0x80, 0xc0, 0xe0, 0x7c, 0x7c, 0x3f, 0x3f, 0x1f, 0x1f, 0x9f, 0x8f, 0x8f, 0x87, 0x3, 0x1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x60, 0x70, 0xf0, 0xf8, 0xf8, 0xfc, 0xfc, 0xfc, 0x3e, 0x1e, 0xe, 0x6, 0x7, 0x7, 0xc3, 0xe3, 0xf1, 0xf0, 0x18, 0x18, 0x3c, 0x1c, 0xe, 0xe, 0xcc, 0xfc, 0xfc, 0xfc, 0xf8, 0xf9, 0x39, 0x19, 0x1f, 0xff, 0xff, 0xff, 0xf3, 0xf3, 0xf1, 0xf1, 0xf1, 0xf1, 0x18, 0x18, 0x7c, 0x7c, 0x3e, 0x3f, 0x3f, 0x1f, 0x1f, 0x13, 0x3, 0xc3, 0xc7, 0x47, 0x47, 0x46, 0x46, 0x4e, 0x7c, 0x38, 0x30, 0x00, 0x00, 0xe0, 0xf1, 0xf9, 0x7f, 0x3f, 0x3f, 0xff, 0xf8, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0xc1, 0xc3, 0xc3, 0x82, 0x82, 0x86, 0x84, 0x84, 0x84, 0x84, 0x84, 0x88, 0x88, 0x8, 0x8, 0x8, 0x9, 0x9, 0x9, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0xcc, 0xcc, 0xc4, 0xc4, 0xc4, 0xe4, 0xe6, 0xe2, 0xf2, 0xf3, 0xf1, 0xf1, 0xf9, 0xf8, 0xf8, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0x10, 0x30, 0x30, 0x21, 0x60, 0x40, 0x40, 0xc7, 0x87, 0x8f, 0x83, 0x81, 0x11, 0x1f, 0x1f, 0x3f, 0x3f, 0x7, 0x7, 0x3f, 0x3f, 0x3f, 0x3f, 0x3f, 0x3f, 0x3f, 0x1f, 0x1f, 0x7f, 0x7f, 0x7f, 0x7f, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x1f, 0x7f, 0x7f, 0x7f, 0x7f, 0x7f, 0x7f, 0x7f, 0x3f, 0x3f, 0x3f, 0x1f, 0x1f, 0x3, 0x3, 0x7, 0x7, 0xf, 0xf, 0x87, 0x87, 0xcf, 0x47, 0x67, 0x23, 0x21, 0x11};
const unsigned char TITLE_SCREEN_RIGHT[] PROGMEM = {0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xf8, 0x88, 0x88, 0x88, 0x88, 0x8, 0x00, 0xf8, 0xf8, 0x38, 0xf0, 0xc0, 0x80, 0xf0, 0xf0, 0x00, 0xf8, 0xf8, 0x18, 0x18, 0x18, 0x18, 0xf8, 0xf8, 0x00, 0xf8, 0xf8, 0xc0, 0xe0, 0x70, 0x38, 0x00, 0xf8, 0xf8, 0x98, 0x98, 0x98, 0x18, 0x00, 0x00, 0x00, 0xf, 0xe, 0xfe, 0xf8, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x1b, 0x1b, 0x1b, 0x1b, 0x19, 0x1f, 0x1f, 0x00, 0x1f, 0x1f, 0x00, 0x00, 0x3, 0x7, 0x1f, 0x1f, 0x00, 0x1f, 0x1f, 0x3, 0x3, 0x3, 0x3, 0x1f, 0x1f, 0x00, 0x1f, 0x1f, 0x1, 0x3, 0x1f, 0x1e, 0x00, 0x1f, 0x1f, 0x19, 0x19, 0x18, 0x18, 0x00, 0x00, 0x00, 0xf8, 0xff, 0x7f, 0x1f, 0x3, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1, 0x1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x9e, 0x1e, 0x1e, 0x3e, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfc, 0xfc, 0xfc, 0xfc, 0xc, 0x8, 0x10, 0xf0, 0xe0, 0xe0, 0xc0, 0xc0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x19, 0x19, 0x19, 0x8, 0x8, 0x8, 0xc, 0xc, 0xc, 0xc, 0xc, 0xc, 0xc, 0xc, 0x4, 0x4, 0x4, 0xc, 0x8, 0x8, 0x8, 0x8, 0x11, 0x31, 0x60, 0xc0, 0x87, 0x8e, 0x98, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3c, 0x22, 0x22, 0x00, 0x3e, 0x8, 0x3e, 0x00, 0x3e, 0x22, 0x3e, 0x00, 0x3e, 0x22, 0x3e, 0x00, 0x2, 0x3e, 0x2, 0x00, 0x22, 0x3a, 0x22, 0x00, 0x3e, 0x2, 0x3c, 0x00, 0x00};
const unsigned char PAUSE_GRAPHIC[] PROGMEM = {0xff, 0x3, 0x1, 0x1, 0xe1, 0xa1, 0xe1, 0x1, 0xe1, 0xa1, 0xe1, 0x1, 0xe1, 0x1, 0xe1, 0x1, 0xe1, 0xa1, 0xa1, 0x1, 0xe1, 0xa1, 0xa1, 0x1, 0xe1, 0x21, 0x21, 0xc1, 0x1, 0x1, 0x3, 0xff, 0xff, 0xc0, 0x80, 0x80, 0x87, 0x80, 0x80, 0x80, 0x87, 0x80, 0x87, 0x80, 0x87, 0x84, 0x87, 0x80, 0x84, 0x84, 0x87, 0x80, 0x87, 0x84, 0x84, 0x80, 0x87, 0x84, 0x84, 0x83, 0x80, 0x80, 0xc0, 0xff};
const unsigned char DEATH_BOX[] PROGMEM = {0xfe, 0x1, 0xf1, 0x5d, 0xcd, 0xbd, 0xcd, 0x5d, 0xf1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0xfe, 0x7, 0x8, 0x8, 0xb, 0xa, 0xa, 0xa, 0xb, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x7};

Arduboy2 arduboy;
struct snake snake;
struct block food;
unsigned int direction = RIGHT;
bool paused = false, dead = false;
bool left_held = false;
bool up_held = false;
bool right_held = false;
bool down_held = false;
bool a_held = false;
bool b_held = false;

void setup() {
  arduboy.boot();
  arduboy.setFrameRate(20);
  arduboy.initRandomSeed();
  snake.chunks = new struct block[255];
  reset();
  for (int i = 0; i < snake.length; i++) {
    snake.chunks[i] = {0, 0};
  }
  new_food();

  arduboy.clear();
  char *title_screen = TITLE_SCREEN_LEFT;
  arduboy.drawBitmap(0, 0, title_screen, 64, 64, WHITE);
  title_screen = TITLE_SCREEN_RIGHT;
  arduboy.drawBitmap(64, 0, title_screen, 64, 64, WHITE);
  arduboy.display();

  while (true) {
    if (check_button(B_BUTTON, &b_held)) {
      break;
    }
  }
}

void loop() {
  if (!arduboy.nextFrame()) {
    return;
  }
  
  process_input();

  if (!paused && !dead) {
    move_snake();
    if (snake_collided()) {
      lose();
    }
    if (food_collided()) {
      eat_food();
    }
  }
  
  arduboy.clear();
  draw_food();
  draw_snake();
  draw_interface();
  arduboy.display();
}

void process_input() {
  if (check_button(A_BUTTON, &a_held)) {
  }
  
  if (check_button(B_BUTTON, &b_held)) {
      if (dead) {
        reset();
      } else {
        paused = !paused;
      }
  }

  if (paused || dead) {
    return;
  }
  
  if (check_button(LEFT_BUTTON, &left_held)) {
    if (!(paused || dead)) {
      if (direction != RIGHT) {
         direction = LEFT;
      }
    }
  }
  
  if (check_button(UP_BUTTON, &up_held)) {
    if (!(paused || dead)) {
      if (direction != DOWN) {
         direction = UP;
      }
    }
  }
  
  if (check_button(RIGHT_BUTTON, &right_held)) {
    if (!(paused || dead)) {
      if (direction != LEFT) {
         direction = RIGHT;
      }
    }
  }
  
  if (check_button(DOWN_BUTTON, &down_held)) {
    if (!(paused || dead)) {
      if (direction != UP) {
         direction = DOWN;
      }
    }
  }
}

bool check_button(unsigned int button, bool *held_ref) {
  if (arduboy.pressed(button)) {
    if (!*held_ref) {
      *held_ref = true;
      return true;
    }
  } else {
    *held_ref = false;
  }
  
  return false;
}

void move_snake() {
  for (int i = snake.length - 1; i > 0; i--) {
    snake.chunks[i].x = snake.chunks[i - 1].x;
    snake.chunks[i].y = snake.chunks[i - 1].y;
  }
  
  switch (direction) {
    case RIGHT:
      snake.chunks[0].x = snake.chunks[0].x + 1;
      break;
     case DOWN:
      snake.chunks[0].y = snake.chunks[0].y + 1;
      break;
     case LEFT:
      snake.chunks[0].x = snake.chunks[0].x - 1;
      break;
     case UP:
      snake.chunks[0].y = snake.chunks[0].y - 1;
      break;
  }

  if (snake.chunks[0].x >= MAX_X) {
    snake.chunks[0].x = 0;
  } else if (snake.chunks[0].x < 0) {
    snake.chunks[0].x = MAX_X - 1;
  }

  if (snake.chunks[0].y >= MAX_Y) {
    snake.chunks[0].y = 0;
  } else if (snake.chunks[0].y < 0) {
    snake.chunks[0].y = MAX_Y - 1;
  }
}

bool snake_collided() {
  int x = snake.chunks[0].x;
  int y = snake.chunks[0].y;
  for (int i = 1; i < snake.length; i++) {
    if (snake.chunks[i].x == x && snake.chunks[i].y == y) {
      return true;
    }
  }
  return false;
}

bool food_collided() {
  return snake.chunks[0].x == food.x && snake.chunks[0].y == food.y;
}

void eat_food() {
  snake.chunks[snake.length] = {snake.chunks[0].x, snake.chunks[0].y};
  snake.length = snake.length + 1;
  new_food();
}

void new_food() {
  unsigned int x = random(0, MAX_X);
  unsigned int y = random(0, MAX_Y);
  food = {x, y};
}

void draw_food() {
  arduboy.fillRect(food.x * BLOCK_WIDTH, food.y * BLOCK_WIDTH, BLOCK_WIDTH, BLOCK_WIDTH, WHITE);
}

void draw_snake() {
  for (int i = 0; i < snake.length; i++) {
    struct block chunk = snake.chunks[i];
    arduboy.fillRect(chunk.x * BLOCK_WIDTH, chunk.y * BLOCK_WIDTH, BLOCK_WIDTH, BLOCK_WIDTH, WHITE);
  }
}

void draw_interface() {
  if (paused) {
    char *pause_graphic = PAUSE_GRAPHIC;
    draw_graphic(pause_graphic, 32, 16, WIDTH / 2, HEIGHT / 2, true, true);
  } else if (dead) {
    char *dead_graphic = DEATH_BOX;
    int x = WIDTH / 2;
    int y = HEIGHT / 2;
    draw_graphic(dead_graphic, 80, 12, x, y, true, true);
    arduboy.setCursor(x - 28, y - 4);
    arduboy.print("Score: ");
    arduboy.print(snake.length);
  }
}

void reset() {
  snake.length = INITIAL_LENGTH;
  dead = false;
  //TODO: position in multiplayer
}

void lose() {
  dead = true;
}

void draw_graphic(char * graphic, int size_x, int size_y, unsigned int x, unsigned int y, bool origin_center, bool blank) {
    char *pause_graphic = PAUSE_GRAPHIC;
    if (origin_center) {
      x = x - size_x / 2;
      y = y - size_y / 2;
    }
    if (blank) {
      arduboy.fillRect(x, y, size_x, size_y, BLACK);
    }
    arduboy.drawBitmap(x, y, graphic, size_x, size_y, WHITE);
}

